id: load_order_list
namespace: aag.prod
description: "ORDER_LIST Complete Pipeline - SharePoint to SQL Server (4-stage ETL)"

triggers:
  - id: ev_hour
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "0 * * * *"

variables:
  tenantID: "{{ kv('AZ_TENANT_ID') }}"


tasks:
  - id: setup_and_log
    type: io.kestra.plugin.core.log.Log
    message: |
      ğŸš€ Starting Workflow: {{ flow.id }}
      ğŸ“… Timestamp: {{ now() }}
      ğŸ—ï¸  Namespace: {{ flow.namespace }}
      ğŸ“ Script Location: pipelines/scripts/load_order_list/
      ğŸ—„ï¸  Target Database: ORDER_LIST â†’ SQL Server
      
  - id: execute_main_workflow
    type: io.kestra.plugin.core.flow.WorkingDirectory
    description: "Execute ORDER_LIST pipeline with environment configuration and database-only authentication"
    namespaceFiles:
      enabled: true
      include:
        - pipelines/**
        - configs/**
        - utils/**
        - db/**
    tasks:
      - id: load_order_list
        type: io.kestra.plugin.scripts.python.Commands
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
          pullPolicy: NEVER
        containerImage: my-custom-kestra:latest
        description: "Execute ORDER_LIST complete pipeline: SharePoint â†’ Blob â†’ Extract â†’ Transform â†’ Load"
        namespaceFiles:
          enabled: true
        env:
          AZ_TENANT_ID: "{{ secret('AZ_TENANT_ID') }}"
          BLOB_CLIENT_ID: "{{ secret('BLOB_CLIENT_ID') }}"
          BLOB_CLIENT_SECRET: "{{ secret('BLOB_CLIENT_SECRET') }}"
          BLOB_ACCOUNT_NAME: "{{ secret('BLOB_ACCOUNT_NAME') }}"
          BLOB_ACCOUNT_KEY: "{{ secret('BLOB_ACCOUNT_KEY') }}" 
          
        
        commands:
          - echo "ğŸš€ === ORDER_LIST Pipeline Starting ==="
          - echo "ğŸ“Š Executing complete SharePoint â†’ SQL workflow..."
          - python pipelines/scripts/load_order_list/order_list_pipeline.py
          - echo "âœ… === ORDER_LIST Pipeline Completed ==="

          
  - id: completion_log
    type: io.kestra.plugin.core.log.Log
    message: |
      âœ… ORDER_LIST Pipeline completed successfully!
      ğŸ“Š Workflow: {{flow.id}}
      ğŸ“ˆ Results: SharePoint files processed â†’ SQL Server ORDER_LIST table updated
      â° Completed at: {{ now() }}
